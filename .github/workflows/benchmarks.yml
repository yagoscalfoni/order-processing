name: Benchmarks

on:
  workflow_dispatch:

jobs:
  repository-benchmarks:
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: "Y"
          MSSQL_SA_PASSWORD: Your_password123
        ports:
          - 1433:1433
        options: >-
          --health-cmd "bash -c 'cat < /dev/null > /dev/tcp/localhost/1433'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: DEBUG â€“ show docker command
        run: |
          echo "USING /opt/mssql-tools/bin/sqlcmd"
          echo "NO --network host"

      - name: Initialize database schema
        run: |
          docker run --rm \
            --network "${{ job.services.sqlserver.network }}" \
            -v "${{ github.workspace }}/db/init:/scripts" \
            mcr.microsoft.com/mssql-tools:latest \
            /opt/mssql-tools/bin/sqlcmd \
            -S sqlserver \
            -U sa \
            -P Your_password123 \
            -i /scripts/001_create_schema.sql
