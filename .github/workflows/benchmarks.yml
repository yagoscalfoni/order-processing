name: Benchmarks

on:
  workflow_dispatch:

jobs:
  repository-benchmarks:
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: "Y"
          MSSQL_SA_PASSWORD: Your_password123
        ports:
          - 1433:1433
        options: >-
          --health-cmd "bash -c 'cat < /dev/null > /dev/tcp/localhost/1433'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # Debug defensivo – pode remover depois que estabilizar
      - name: DEBUG – show workspace structure
        run: |
          echo "Root:"
          ls -la
          echo ""
          echo "OrderProcessing/db/init:"
          ls -la OrderProcessing/db/init
          echo ""
          echo "Benchmarks project:"
          ls -la OrderProcessing/src/OrderProcessing.Benchmarks

      - name: Initialize database schema
        run: |
          docker run --rm \
            --network "${{ job.services.sqlserver.network }}" \
            -v "${{ github.workspace }}/OrderProcessing/db/init:/scripts" \
            mcr.microsoft.com/mssql-tools:latest \
            /opt/mssql-tools/bin/sqlcmd \
            -S sqlserver \
            -U sa \
            -P Your_password123 \
            -d master \
            -i /scripts/001_create_schema.sql

      - name: Run repository benchmarks
        env:
          ConnectionStrings__Orders: >
            Server=sqlserver,1433;
            Database=orders;
            User Id=sa;
            Password=Your_password123;
            TrustServerCertificate=True
        run: |
          dotnet run -c Release \
            --project OrderProcessing/src/OrderProcessing.Benchmarks/OrderProcessing.Benchmarks.csproj

      - name: Publish benchmark summary
        if: always()
        run: |
          echo "## BenchmarkDotNet Results" >> "$GITHUB_STEP_SUMMARY"
          if [ -d "OrderProcessing/src/OrderProcessing.Benchmarks/BenchmarkDotNet.Artifacts" ]; then
            find OrderProcessing/src/OrderProcessing.Benchmarks/BenchmarkDotNet.Artifacts \
              -name "*.md" -print0 | while IFS= read -r -d '' file; do
                echo "" >> "$GITHUB_STEP_SUMMARY"
                echo "### $(basename "$file")" >> "$GITHUB_STEP_SUMMARY"
                cat "$file" >> "$GITHUB_STEP_SUMMARY"
              done
          else
            echo "No BenchmarkDotNet artifacts found." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload benchmark artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarkdotnet-artifacts
          path: OrderProcessing/src/OrderProcessing.Benchmarks/BenchmarkDotNet.Artifacts
